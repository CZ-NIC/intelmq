#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Created on Fri Sep 11 14:13:21 2015

@author: sebastian
"""
from __future__ import unicode_literals, print_function

import psycopg2


from intelmq import RUNTIME_CONF_FILE
import intelmq.lib.utils as utils


DBPARAMS = utils.load_configuration(RUNTIME_CONF_FILE)['postgresql-output']
DBTABLE = DBPARAMS['table']
CON = psycopg2.connect(database=DBPARAMS['database'],
                       user=DBPARAMS['user'],
                       password=DBPARAMS['password'],
                       host=DBPARAMS['host'],
                       port=DBPARAMS['port'],
                       sslmode=DBPARAMS['sslmode'],
                       )
CUR = CON.cursor()
QUERY_COUNT = """
SELECT COUNT(*)
FROM {}
WHERE
    notify = TRUE;
""".format(DBTABLE)
QUERY_COUNT_ASN = """
SELECT COUNT(*) as count, "source.asn" as asn
FROM {}
WHERE
    notify = TRUE AND
    "source.geolocation.cc" = 'AT'
GROUP BY
    "source.asn";
""".format(DBTABLE)
QUERY_ASN = """
SELECT
    contacts, cc_contacts
FROM as_contacts
WHERE
    asnum = %s;
"""


def get_contact(asn):
    CUR.execute(QUERY_ASN, (asn, ))
    return CUR.fetchone()


def count_all():
    CUR.execute(QUERY_COUNT)
    print(CUR.fetchall())


def count_by_asn():
    CUR.execute(QUERY_COUNT_ASN)
    for row in CUR.fetchall():
        print("{} {} {}".format(row[0], row[1], get_contact(row[1])))

if __name__ == '__main__':
    count_by_asn()
